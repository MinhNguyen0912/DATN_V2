@using DATN.Core.Enum
@using DATN.Core.Model.Product_EAV
@using DATN.Core.ViewModel.BatchVM
@using DATN.Core.ViewModel.CategoryVM
@using DATN.Core.ViewModel.Product_EAV
@model CreateBatchRequest

@{
    ViewData["Title"] = "Create Batch";
}

<h2>Create Batch</h2>

<form asp-action="Create" method="post">
    <div class="form-group">
        <label asp-for="Name"></label>
        <input asp-for="Name" class="form-control" />
        <span asp-validation-for="Name" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Description"></label>
        <textarea asp-for="Description" class="form-control"></textarea>
        <span asp-validation-for="Description" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Type"></label>
        <select asp-for="Type" class="form-control" asp-items="Html.GetEnumSelectList<VoucherType>()">
            <option value="">-- Select Type --</option>
        </select>
        <span asp-validation-for="Type" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="DiscountType"></label>
        <select asp-for="DiscountType" class="form-control" asp-items="Html.GetEnumSelectList<DiscountType>()" id="DiscountType">
            <option value="">-- Select Discount Type --</option>
        </select>
        <span asp-validation-for="DiscountType" class="text-danger"></span>
    </div>

    <div class="form-group" id="maxDiscountAmountField" style="display:none;">
        <label asp-for="MaxDiscountAmount"></label>
        <input asp-for="MaxDiscountAmount" class="form-control" type="number" step="0.01" />
        <span asp-validation-for="MaxDiscountAmount" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="DiscountAmount"></label>
        <input asp-for="DiscountAmount" class="form-control" type="number" step="0.01" />
        <span asp-validation-for="DiscountAmount" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="MinOrderAmount"></label>
        <input asp-for="MinOrderAmount" class="form-control" type="number" step="0.01" />
        <span asp-validation-for="MinOrderAmount" class="text-danger"></span>
    </div>

    <!-- Chọn loại thời gian áp dụng -->
    <div class="form-group">
        <label>Chọn loại thời gian:</label><br />
        <input type="radio" name="timeOption" value="validityPeriod" id="validityPeriodRadio" checked />
        <label for="validityPeriodRadio">Thời gian áp dụng (StartDate/EndDate)</label><br />
        <input type="radio" name="timeOption" value="expirationPeriod" id="expirationPeriodRadio" />
        <label for="expirationPeriodRadio">Thời hạn sử dụng (ExpirationDate)</label>
    </div>

    <!-- Thời gian áp dụng: StartDate và EndDate -->
    <div id="validityPeriodFields">
        <div class="form-group">
            <label asp-for="StartDate"></label>
            <input asp-for="StartDate" class="form-control" type="datetime-local" id="StartDate" />
            <span asp-validation-for="StartDate" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="EndDate"></label>
            <input asp-for="EndDate" class="form-control" type="datetime-local" id="EndDate" />
            <span asp-validation-for="EndDate" class="text-danger"></span>
        </div>
    </div>

    <!-- Thời hạn sử dụng: ExpirationDate -->
    <div id="expirationPeriodField" style="display:none;">
        <div class="form-group">
            <label asp-for="ExpirationDate"></label>
            <input asp-for="ExpirationDate" class="form-control" type="number" id="ExpirationDate" />
            <span asp-validation-for="ExpirationDate" class="text-danger"></span>
        </div>
    </div>

    <div class="form-group">
        <input asp-for="ApplyToAll" type="checkbox" id="applyToAll" />
        <label for="applyToAll">Áp dụng cho tất cả danh mục và sản phẩm</label>
    </div>

    <div class="form-group">
        <label>Danh mục áp dụng</label>
        <input type="text" class="form-control" id="search_cate" placeholder="Tìm kiếm..." />
        <ul class="CateList">
            @foreach (var item in ViewBag.Cates as List<CategoryVM>)
            {
                <li>
                    <input type="checkbox" name="CateItem" value="@item.Id" class="category-checkbox" />
                    <span>@item.Name</span>
                </li>
            }
        </ul>
    </div>

    <div class="form-group">
        <label>Sản phẩm áp dụng</label>
        <input type="text" class="form-control" id="search_product" placeholder="Tìm kiếm..." />
        <ul class="ProdList">
            @foreach (var item in ViewBag.Products as List<Product_EAV>)
            {
                <li>
                    <input type="checkbox" name="ProdItem" value="@item.ProductId" class="product-checkbox" />
                    <span>@item.ProductName</span>
                </li>
            }
        </ul>
    </div>

    <button type="submit" class="btn btn-primary">Create</button>
</form>

@section Scripts {
    <script>
        // Hiển thị MaxDiscountAmount khi DiscountType là Percent
        document.getElementById("DiscountType").addEventListener("change", function () {
            var discountType = this.value;
            var maxDiscountField = document.getElementById("maxDiscountAmountField");

            if (discountType === 'Percent') {
                maxDiscountField.style.display = "block";
            } else {
                maxDiscountField.style.display = "none";
            }
        });

        // Xử lý hiển thị trường dựa trên radio button
        document.getElementById("validityPeriodRadio").addEventListener("change", function () {
            toggleTimeFields(this.value);
        });

        document.getElementById("expirationPeriodRadio").addEventListener("change", function () {
            toggleTimeFields(this.value);
        });

        function toggleTimeFields(value) {
            var validityPeriodFields = document.getElementById("validityPeriodFields");
            var expirationPeriodField = document.getElementById("expirationPeriodField");

            if (value === 'validityPeriod') {
                validityPeriodFields.style.display = "block";
                expirationPeriodField.style.display = "none";
                document.getElementById("ExpirationDate").value = ''; // Xóa giá trị nếu chuyển sang loại kia
            } else if (value === 'expirationPeriod') {
                validityPeriodFields.style.display = "none";
                expirationPeriodField.style.display = "block";
                document.getElementById("StartDate").value = ''; // Xóa giá trị nếu chuyển sang loại kia
                document.getElementById("EndDate").value = ''; // Xóa giá trị nếu chuyển sang loại kia
            }
        }

        // Xử lý logic cho checkbox "Áp dụng cho tất cả"
        document.getElementById('applyToAll').addEventListener('change', function () {
            const isChecked = this.checked;
            document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
                checkbox.disabled = isChecked;
            });
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
                checkbox.disabled = isChecked;
            });
        });

        // Tìm kiếm danh sách category
        document.getElementById('search_cate').addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            const categoryItems = document.querySelectorAll('.CateList li');
            categoryItems.forEach(item => {
                const text = item.innerText.toLowerCase();
                item.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Tìm kiếm danh sách product
        document.getElementById('search_product').addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            const productItems = document.querySelectorAll('.ProdList li');
            productItems.forEach(item => {
                const text = item.innerText.toLowerCase();
                item.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
