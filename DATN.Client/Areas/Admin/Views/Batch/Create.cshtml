@using DATN.Core.Enum
@using DATN.Core.Model.Product_EAV
@using DATN.Core.ViewModel.BatchVM
@using DATN.Core.ViewModel.CategoryVM
@using DATN.Core.ViewModel.Product_EAV
@model CreateBatchRequest

@{
    ViewData["Title"] = "Create Batch";
}
<style>
    .fixed-size {
        height: 300px;
        overflow-y: auto;
    }

    .row {
        margin-bottom: 15px;
    }
</style>
<h2>Tạo Đợt Phát Hành</h2>

<form asp-action="Create" method="post">
    <!-- Thông tin Đợt Phát Hành -->
    <fieldset>
        <legend>Thông tin Đợt Phát Hành</legend>

        <div class="form-group">
            <label asp-for="Name">Tên Đợt Phát Hành:</label>
            <input asp-for="Name" class="form-control" />
            <span asp-validation-for="Name" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Description">Mô Tả:</label>
            <textarea asp-for="Description" class="form-control"></textarea>
            <span asp-validation-for="Description" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Type">Loại Giảm Giá:</label>
            <select asp-for="Type" class="form-control" asp-items="Html.GetEnumSelectList<VoucherType>()" id="VoucherType">
                <option value="">-- Chọn Loại Giảm Giá --</option>
            </select>
            <span asp-validation-for="Type" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="DiscountType">Loại Giảm Giá:</label>
            <select asp-for="DiscountType" class="form-control" asp-items="Html.GetEnumSelectList<DiscountType>()" id="DiscountType">
                <option value="">-- Chọn Loại Giảm Giá --</option>
            </select>
            <span asp-validation-for="DiscountType" class="text-danger"></span>
        </div>

        <div class="form-group" id="maxDiscountAmountField" style="display:none;">
            <label asp-for="MaxDiscountAmount">Số Tiền Giảm Giá Tối Đa:</label>
            <input asp-for="MaxDiscountAmount" class="form-control" type="number" step="0.01" />
            <span asp-validation-for="MaxDiscountAmount" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="DiscountAmount">Số Tiền Giảm Giá:</label>
            <input asp-for="DiscountAmount" class="form-control" type="number" step="0.01" />
            <span asp-validation-for="DiscountAmount" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="MinOrderAmount">Số Tiền Đơn Hàng Tối Thiểu:</label>
            <input asp-for="MinOrderAmount" class="form-control" type="number" step="0.01" />
            <span asp-validation-for="MinOrderAmount" class="text-danger"></span>
        </div>
    </fieldset>

    <!-- Phạm Vi Áp Dụng -->
    <fieldset>
        <legend>Phạm Vi Áp Dụng</legend>

        <!-- Chọn loại thời gian áp dụng -->
        <div class="form-group">
            <label>Chọn loại thời gian:</label><br />
            <div class="row">
                <div class="col-md-6">
                    <input type="radio" name="timeOption" value="validityPeriod" id="validityPeriodRadio" checked />
                    <label for="validityPeriodRadio">Thời gian áp dụng (StartDate/EndDate)</label>
                </div>
                <div class="col-md-6">
                    <input type="radio" name="timeOption" value="expirationPeriod" id="expirationPeriodRadio" />
                    <label for="expirationPeriodRadio">Thời hạn sử dụng (ExpirationDate)</label>
                </div>
            </div>
        </div>

        <!-- Thời gian áp dụng: StartDate và EndDate -->
        <div id="validityPeriodFields" class="row">
            <div class="form-group col-md-6">
                <label asp-for="StartDate">Ngày Bắt Đầu:</label>
                <input asp-for="StartDate" class="form-control" type="datetime-local" id="StartDate" />
                <span asp-validation-for="StartDate" class="text-danger"></span>
            </div>

            <div class="form-group col-md-6">
                <label asp-for="EndDate">Ngày Kết Thúc:</label>
                <input asp-for="EndDate" class="form-control" type="datetime-local" id="EndDate" />
                <span asp-validation-for="EndDate" class="text-danger"></span>
            </div>
        </div>

        <!-- Thời hạn sử dụng: ExpirationDate -->
        <div id="expirationPeriodField" style="display:none;" class="form-group">
            <label asp-for="ExpirationDate">Thời Gian Hết Hạn (Ngày):</label>
            <input asp-for="ExpirationDate" class="form-control" type="number" id="ExpirationDate" />
            <span asp-validation-for="ExpirationDate" class="text-danger"></span>
        </div>

        <div class="form-group">
            <input asp-for="ApplyToAll" type="checkbox" id="applyToAll" />
            <label for="applyToAll">Áp dụng cho tất cả danh mục và sản phẩm</label>
        </div>

        <div class="row">
            <!-- Danh mục áp dụng -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Danh mục áp dụng
                        <input type="text" class="form-control" id="search_cate" placeholder="Tìm kiếm..." />
                    </div>
                    <div class="card-body fixed-size">
                        <table class="table table-bordered table-hover CateList">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllCategories" /></th>
                                    <th>Tên Danh Mục</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in ViewBag.Cates as List<CategoryVM>)
                                {
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="CateItem" value="@item.Id" class="category-checkbox" />
                                        </td>
                                        <td>@item.Name</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sản phẩm áp dụng -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Sản phẩm áp dụng
                        <input type="text" class="form-control" id="search_product" placeholder="Tìm kiếm..." />
                    </div>
                    <div class="card-body fixed-size">
                        <table class="table table-bordered table-hover ProdList">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllProducts" /></th>
                                    <th>Tên Sản Phẩm</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in ViewBag.Products as List<Product_EAV>)
                                {
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="ProdItem" value="@item.ProductId" class="product-checkbox" />
                                        </td>
                                        <td>@item.ProductName</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </fieldset>

    <button type="submit" class="btn btn-primary">Tạo</button>
</form>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const voucherType = document.getElementById('VoucherType');
            const discountType = document.getElementById('DiscountType');
            const discountAmount = document.getElementById('DiscountAmount');
            const maxDiscountField = document.getElementById('maxDiscountAmountField');

            function updateFields() {
                if (voucherType.value === '0') {
                    discountType.value = '0';
                    discountAmount.value = '100';
                    discountType.disabled = true;  // Disable DiscountType dropdown
                    discountAmount.disabled = true; // Disable DiscountAmount input
                } else {
                    discountType.disabled = false; // Enable DiscountType dropdown
                    discountAmount.disabled = false; // Enable DiscountAmount input
                }
            }

            voucherType.addEventListener('change', updateFields);

            // Initial check
            updateFields();

            // Hiển thị MaxDiscountAmount khi DiscountType là Percent (giá trị '0')
            document.getElementById("DiscountType").addEventListener("change", function () {
                var discountType = this.value; // Lấy giá trị của select (0 hoặc 1)
                var maxDiscountField = document.getElementById("maxDiscountAmountField");

                // Kiểm tra giá trị của DiscountType (0 cho Percent)
                if (discountType === '0') { // Kiểm tra nếu là 0
                    maxDiscountField.style.display = "block"; // Hiển thị trường MaxDiscountAmount
                } else {
                    maxDiscountField.style.display = "none"; // Ẩn trường MaxDiscountAmount
                }
            });

            // Thiết lập hiển thị ban đầu cho MaxDiscountAmount
            var initialDiscountType = document.getElementById("DiscountType").value;
            if (initialDiscountType === '0') { // Kiểm tra nếu là 0
                document.getElementById("maxDiscountAmountField").style.display = "block";
            } else {
                document.getElementById("maxDiscountAmountField").style.display = "none";
            }

            // Xử lý hiển thị trường dựa trên radio button
            document.getElementById("validityPeriodRadio").addEventListener("change", function () {
                toggleTimeFields(this.value);
            });

            document.getElementById("expirationPeriodRadio").addEventListener("change", function () {
                toggleTimeFields(this.value);
            });

            function toggleTimeFields(value) {
                var validityPeriodFields = document.getElementById("validityPeriodFields");
                var expirationPeriodField = document.getElementById("expirationPeriodField");

                if (value === 'validityPeriod') {
                    validityPeriodFields.style.display = "block";
                    expirationPeriodField.style.display = "none";
                    document.getElementById("ExpirationDate").value = ''; // Xóa giá trị nếu chuyển sang loại kia
                } else if (value === 'expirationPeriod') {
                    validityPeriodFields.style.display = "none";
                    expirationPeriodField.style.display = "block";
                    document.getElementById("StartDate").value = ''; // Xóa giá trị nếu chuyển sang loại kia
                    document.getElementById("EndDate").value = ''; // Xóa giá trị nếu chuyển sang loại kia
                }
            }

            // Xử lý logic cho checkbox "Áp dụng cho tất cả"
            document.getElementById('applyToAll').addEventListener('change', function () {
                const isChecked = this.checked;
                document.querySelectorAll('.category-checkbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                    checkbox.disabled = isChecked;
                });
                document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                    checkbox.disabled = isChecked;
                });
            });

            // Tìm kiếm danh sách category
            document.getElementById('search_cate').addEventListener('input', function () {
                const searchTerm = this.value.toLowerCase();
                const categoryRows = document.querySelectorAll('.CateList tbody tr'); // Thay đổi selector thành các hàng trong bảng
                categoryRows.forEach(row => {
                    const text = row.innerText.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });

            // Tìm kiếm danh sách product
            document.getElementById('search_product').addEventListener('input', function () {
                const searchTerm = this.value.toLowerCase();
                const productRows = document.querySelectorAll('.ProdList tbody tr'); // Thay đổi selector thành các hàng trong bảng
                productRows.forEach(row => {
                    const text = row.innerText.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });

            // Select All Categories
            document.getElementById('selectAllCategories').addEventListener('change', function () {
                const isChecked = this.checked;
                const categoryCheckboxes = document.querySelectorAll('.CateList .category-checkbox');
                categoryCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
            });

            // Select All Products
            document.getElementById('selectAllProducts').addEventListener('change', function () {
                const isChecked = this.checked;
                const productCheckboxes = document.querySelectorAll('.ProdList .product-checkbox');
                productCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
            });
        });
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
